////////////////////////////////////////////////////////////////////////////////
// SPDX-License-Identifier: MIT
// Copyright (c) 2026 Андриянов Роман (Androman.pro)
// https://opensource.org/license/mit
////////////////////////////////////////////////////////////////////////////////

#Область ПрограммныйИнтерфейс
// Преобразует текст в формате Markdown в HTML разметку
//
// Функция выполняет последовательную обработку Markdown синтаксиса и преобразует
// его в соответствующие HTML теги. Поддерживает блочные элементы (заголовки, списки,
// таблицы, цитаты), встроенное форматирование (жирный, курсив, зачеркнутый текст),
// блоки и фрагменты кода, а также гиперссылки.
//
// Порядок обработки оптимизирован для корректной работы со вложенными элементами:
// 1. Блочные элементы (код, таблицы, заголовки, списки)
// 2. Защита inline элементов (код, ссылки) от дальнейшей обработки
// 3. Форматирование текста (жирный, курсив, зачеркнутый)
// 4. Восстановление защищенных элементов
//
// Параметры:
//  Текст - Строка - исходный текст в формате Markdown
//
// Возвращаемое значение:
//  Строка - HTML разметка, готовая для отображения в браузере или HTML-поле
//
// Поддерживаемые элементы Markdown:
//
//  Заголовки:
//   # H1, ## H2, ### H3, #### H4, ##### H5, ###### H6
//
//  Форматирование текста:
//   **жирный** или __жирный__          → <strong>жирный</strong>
//   *курсив* или _курсив_              → <em>курсив</em>
//   ***жирный курсив***                → <strong><em>жирный курсив</em></strong>
//   ~~зачеркнутый~~                    → <del>зачеркнутый</del>
//
//  Код:
//   `inline код`                       → <code>inline код</code>
//   ```язык                            → <pre><code class="language-язык">
//   блок кода                            блок кода
//   ```                                  </code></pre>
//
//  Списки:
//   - элемент списка                   → <ul><li>элемент списка</li></ul>
//   * элемент списка
//   1. нумерованный список             → <ol><li>нумерованный список</li></ol>
//
//  Ссылки:
//   [текст](url)                       → <a href="url">текст</a>
//   [текст](url "подсказка")           → <a href="url" title="подсказка">текст</a>
//
//  Таблицы:
//   | Заголовок 1 | Заголовок 2 |
//   |-------------|-------------|      → <table><thead><tr><th>...
//   | Ячейка 1    | Ячейка 2    |
//
//  Другое:
//   ---                                → <hr/>
//   > цитата                           → <blockquote>цитата</blockquote>
//
// Примеры:
//
//  // Простое форматирование
//  HTML = КИИ_МаркдаунПарсерКлиентСервер.ПреобразоватьВHTML("Это **жирный** текст");
//  // Результат: "Это <strong>жирный</strong> текст"
//
//  // Заголовок и код
//  Markdown = "# Пример кода" + Символы.ПС + 
//             "```bsl" + Символы.ПС +
//             "Сообщить(""Привет!"");" + Символы.ПС +
//             "```";
//  HTML = КИИ_МаркдаунПарсерКлиентСервер.ПреобразоватьВHTML(Markdown);
//
//  // Таблица
//  Markdown = "| Провайдер | Поддержка |" + Символы.ПС +
//             "|-----------|-----------|" + Символы.ПС +
//             "| OpenAI    | Да        |";
//  HTML = КИИ_МаркдаунПарсерКлиентСервер.ПреобразоватьВHTML(Markdown);
//
//  // Обработка ответа от LLM
//  Ответ = КИИ_КоннекторИИ.ЗапросКМодели(Модель, "Напиши пример на 1С");
//  Если Не Ответ.ЭтоОшибка Тогда
//      HTML = КИИ_МаркдаунПарсерКлиентСервер.ПреобразоватьВHTML(Ответ.ТекстОтвета);
//      // Готовая HTML разметка с подсветкой кода
//  КонецЕсли;
//
// Особенности:
//  - Защита специальных символов HTML не выполняется (предполагается доверенный вход)
//  - Inline код и ссылки обрабатываются с использованием placeholder для предотвращения
//    конфликтов с форматированием
//  - Блоки кода защищаются от обработки в первую очередь
//  - Поддерживается подсветка синтаксиса через атрибут class="language-xxx"
//
Функция ПреобразоватьВHTML(Знач Текст) Экспорт

	Результат = Текст;

	СоответствиеБлоковКода = Новый Соответствие;
	Результат = ОбработатьБлокиКода(Результат, СоответствиеБлоковКода);

	Результат = ОбработатьТаблицы(Результат);
	Результат = ОбработатьЗаголовки(Результат);
	Результат = ОбработатьЦитаты(Результат);
	Результат = ОбработатьСписки(Результат);
	Результат = ОбработатьГоризонтальныеЛинии(Результат);

	СоответствиеИнлайнКода = Новый Соответствие;
	Результат = ЗащититьИнлайнКод(Результат, СоответствиеИнлайнКода);

	СоответствиеСсылок = Новый Соответствие;
	Результат = ЗащититьСсылки(Результат, СоответствиеСсылок);

	Результат = ОбработатьПарныеТеги(Результат, "***", "<strong><em>", "</em></strong>");
	Результат = ОбработатьПарныеТеги(Результат, "___", "<strong><em>", "</em></strong>");
	Результат = ОбработатьПарныеТеги(Результат, "~~", "<del>", "</del>");
	Результат = ОбработатьПарныеТеги(Результат, "**", "<strong>", "</strong>");
	Результат = ОбработатьПарныеТеги(Результат, "__", "<strong>", "</strong>");
	Результат = ОбработатьПарныеТеги(Результат, "*", "<em>", "</em>");
	Результат = ОбработатьПарныеТеги(Результат, "_", "<em>", "</em>");

	Результат = ВосстановитьПлейсхолдеры(Результат, СоответствиеСсылок);
	Результат = ВосстановитьПлейсхолдеры(Результат, СоответствиеИнлайнКода);
	Результат = ВосстановитьПлейсхолдеры(Результат, СоответствиеБлоковКода);

	Возврат Результат;

КонецФункции 

// Экранирует специальные символы HTML для безопасного отображения текста
//
// Параметры:
//  Текст - Строка - исходный текст для экранирования
//
// Возвращаемое значение:
//  Строка - текст с экранированными HTML-символами:
//    & заменяется на &amp;
//    < заменяется на &lt;
//    > заменяется на &gt;
//    " заменяется на &quot;
//    ' заменяется на &#39;
//
// Пример:
//  Текст = "<script>alert('XSS')</script>";
//  БезопасныйТекст = КИИ_МаркдаунПарсерКлиентСервер.ЭкранироватьHTML(Текст);
//  // Результат: "&lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;"
//
Функция ЭкранироватьHTML(Знач Текст) Экспорт

	Результат = Текст;
	Результат = СтрЗаменить(Результат, "&", "&amp;");
	Результат = СтрЗаменить(Результат, "<", "&lt;");
	Результат = СтрЗаменить(Результат, ">", "&gt;");
	Результат = СтрЗаменить(Результат, """", "&quot;");
	Результат = СтрЗаменить(Результат, "'", "&#39;");
	Возврат Результат;

КонецФункции

// Определяет содержит ли текст разметку Markdown
//
// Параметры:
//  Текст - Строка - проверяемый текст
//
// Возвращаемое значение:
//  Булево - Истина, если текст содержит Markdown-разметку
//
Функция ЭтоMarkdown(Знач Текст) Экспорт
	
	Если ПустаяСтрока(Текст) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если ЕстьСтрогиеМаркерыMarkdown(Текст) Тогда
		Возврат Истина;
	КонецЕсли;
	
	МинимальныйБаллMarkdown = 2;
	
	Счетчик = ПодсчитатьБаллыБезРазбораСтрок(Текст);
	
	Если Счетчик >= МинимальныйБаллMarkdown Тогда
		Возврат Истина;
	КонецЕсли;
	
	Счетчик = Счетчик + ПроверитьСтроковыеЭлементы(Текст, Счетчик);
	
	Возврат Счетчик >= МинимальныйБаллMarkdown;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ОпределениеMarkdown

Функция ЕстьСтрогиеМаркерыMarkdown(Текст)
	
	Возврат СтрНайти(Текст, "```") > 0
		Или СтрНайти(Текст, "](http") > 0
		Или СтрНайти(Текст, "|---") > 0
		Или СтрНайти(Текст, "| ---") > 0;
		
КонецФункции

Функция ПодсчитатьБаллыБезРазбораСтрок(Текст)
	
	Счетчик = 0;
	
	Если СтрЧислоВхождений(Текст, "**") >= 2 Тогда
		Счетчик = Счетчик + 1;
	КонецЕсли;
	
	Если СтрЧислоВхождений(Текст, "`") >= 2 И СтрНайти(Текст, "SELECT") = 0 Тогда
		Счетчик = Счетчик + 1;
	КонецЕсли;
	
	Возврат Счетчик;
	
КонецФункции

Функция ПроверитьСтроковыеЭлементы(Текст, НачальныйСчетчик)
	
	Строки = СтрРазделить(Текст, Символы.ПС, Ложь);
	
	Состояние = НовоеСостояниеПоиска();
	Счетчик = НачальныйСчетчик;
	
	Для Каждого Строка Из Строки Цикл
		
		СтрокаОбрезанная = СокрЛП(Строка);
		
		Если ПустаяСтрока(СтрокаОбрезанная) Тогда
			Продолжить;
		КонецЕсли;
		
		ДлинаСтроки = СтрДлина(СтрокаОбрезанная);
		
		Счетчик = Счетчик + ПроверитьСтрокуНаМаркеры(СтрокаОбрезанная, Строка, ДлинаСтроки, Состояние);
		
		Если Счетчик >= 2 Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Счетчик;
	
КонецФункции

Функция НовоеСостояниеПоиска()
	
	Состояние = Новый Структура;
	Состояние.Вставить("ЕстьЗаголовки", Ложь);
	Состояние.Вставить("ЕстьСписки", Ложь);
	Состояние.Вставить("ЕстьЦитаты", Ложь);
	Состояние.Вставить("ЕстьТаблицы", Ложь);
	
	Возврат Состояние;
	
КонецФункции

Функция ПроверитьСтрокуНаМаркеры(СтрокаОбрезанная, СтрокаИсходная, ДлинаСтроки, Состояние)
	
	Баллы = 0;
	
	Баллы = Баллы + ПроверитьЗаголовок(СтрокаОбрезанная, ДлинаСтроки, Состояние);
	Баллы = Баллы + ПроверитьСписок(СтрокаОбрезанная, ДлинаСтроки, Состояние);
	Баллы = Баллы + ПроверитьЦитату(СтрокаОбрезанная, ДлинаСтроки, Состояние);
	Баллы = Баллы + ПроверитьТаблицу(СтрокаИсходная, ДлинаСтроки, Состояние);
	
	Возврат Баллы;
	
КонецФункции

Функция ПроверитьЗаголовок(Строка, Длина, Состояние)
	
	Если Состояние.ЕстьЗаголовки Или Длина < 2 Тогда
		Возврат 0;
	КонецЕсли;
	
	ПервыйСимвол = Лев(Строка, 1);
	
	Если ПервыйСимвол <> "#" Тогда
		Возврат 0;
	КонецЕсли;
	
	ВторойСимвол = Сред(Строка, 2, 1);
	
	Если ВторойСимвол = " " Или ВторойСимвол = "#" Тогда
		Состояние.ЕстьЗаголовки = Истина;
		Возврат 2;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

Функция ПроверитьСписок(Строка, Длина, Состояние)
	
	Если Состояние.ЕстьСписки Или Длина < 2 Тогда
		Возврат 0;
	КонецЕсли;
	
	ПервыйСимвол = Лев(Строка, 1);
	ВторойСимвол = Сред(Строка, 2, 1);
	
	Если ЭтоМаркированныйСписок(ПервыйСимвол, ВторойСимвол) Тогда
		Состояние.ЕстьСписки = Истина;
		Возврат 1;
	КонецЕсли;
	
	Если Длина >= 3 Тогда
		ТретийСимвол = Сред(Строка, 3, 1);
		
		Если ЭтоНумерованныйСписок(ПервыйСимвол, ВторойСимвол, ТретийСимвол) Тогда
			Состояние.ЕстьСписки = Истина;
			Возврат 1;
		КонецЕсли;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

Функция ЭтоМаркированныйСписок(ПервыйСимвол, ВторойСимвол)
	
	ЭтоМаркер = (ПервыйСимвол = "-" Или ПервыйСимвол = "*");
	ЕстьПробел = (ВторойСимвол = " ");
	
	Возврат ЭтоМаркер И ЕстьПробел;
	
КонецФункции

Функция ЭтоНумерованныйСписок(ПервыйСимвол, ВторойСимвол, ТретийСимвол)
	
	ЭтоЦифра = (ПервыйСимвол >= "0" И ПервыйСимвол <= "9");
	ЕстьТочка = (ВторойСимвол = ".");
	ЕстьПробел = (ТретийСимвол = " ");
	
	Возврат ЭтоЦифра И ЕстьТочка И ЕстьПробел;
	
КонецФункции

Функция ПроверитьЦитату(Строка, Длина, Состояние)
	
	Если Состояние.ЕстьЦитаты Или Длина < 2 Тогда
		Возврат 0;
	КонецЕсли;
	
	Если Лев(Строка, 2) = "> " Тогда
		Состояние.ЕстьЦитаты = Истина;
		Возврат 1;
	КонецЕсли;
	
	Возврат 0;
	
КонецФункции

Функция ПроверитьТаблицу(Строка, Длина, Состояние)
	
	Если Состояние.ЕстьТаблицы Тогда
		Возврат 0;
	КонецЕсли;
	
	КоличествоРазделителей = 0;
	
	Для Индекс = 1 По Длина Цикл
		Если Сред(Строка, Индекс, 1) = "|" Тогда
			КоличествоРазделителей = КоличествоРазделителей + 1;
			
			Если КоличествоРазделителей >= 3 Тогда
				Состояние.ЕстьТаблицы = Истина;
				Возврат 2;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Возврат 0;
	
КонецФункции

#КонецОбласти

#Область Плейсхолдеры

Функция СформироватьПлейсхолдер(Знач Префикс)

	Возврат Префикс + Строка(Новый УникальныйИдентификатор) + "§§";

КонецФункции

Функция ВосстановитьПлейсхолдеры(Знач Текст, СоответствиеПлейсхолдеров)

	Результат = Текст;

	Для Каждого Пара Из СоответствиеПлейсхолдеров Цикл
		Результат = СтрЗаменить(Результат, Пара.Ключ, Пара.Значение);
	КонецЦикла;

	Возврат Результат;

КонецФункции

#КонецОбласти

#Область БлокиКода

Функция ОбработатьБлокиКода(Знач Текст, СоответствиеБлоковКода)
	
	Результат = Текст;
	МаркерБлока = "```";
	ПредыдущаяДлина = СтрДлина(Результат);
	
	Пока СтрНайти(Результат, МаркерБлока) > 0 Цикл
		
		ПозицияНачала = СтрНайти(Результат, МаркерБлока);
		Если ПозицияНачала = 0 Тогда
			Прервать;
		КонецЕсли;
		
		СтрокаПослеМаркера = Сред(Результат, ПозицияНачала + 3);
		ПозицияПереносаСтроки = СтрНайти(СтрокаПослеМаркера, Символы.ПС);
		
		Если ПозицияПереносаСтроки = 0 Тогда
			Прервать;
		КонецЕсли;
		
		Язык = СокрЛП(Лев(СтрокаПослеМаркера, ПозицияПереносаСтроки - 1));
		НачалоКода = (ПозицияНачала + 3) + ПозицияПереносаСтроки;
		
		ПозицияКонца = СтрНайти(Сред(Результат, НачалоКода), МаркерБлока);
		Если ПозицияКонца = 0 Тогда
			Прервать;
		КонецЕсли;
		
		ПозицияКонца = НачалоКода + ПозицияКонца - 1;
		ДлинаКода = ПозицияКонца - НачалоКода;
		Код = Сред(Результат, НачалоКода, ДлинаКода);
		Код = ЭкранироватьHTML(Код);
		
		Если ПустаяСтрока(Язык) Тогда
			HTMLКод = СтрШаблон("<pre><code>%1</code></pre>", Код);
		Иначе
			HTMLКод = СтрШаблон("<pre><code class=""language-%1"">%2</code></pre>", 
				ЭкранироватьHTML(Язык), Код);
		КонецЕсли;
		
		Плейсхолдер = СформироватьПлейсхолдер("§§MDBLOCKCODE:");
		СоответствиеБлоковКода.Вставить(Плейсхолдер, HTMLКод);
		
		ТекстДоБлока = Лев(Результат, ПозицияНачала - 1);
		ТекстПослеБлока = Сред(Результат, ПозицияКонца + 3);
		Результат = ТекстДоБлока + Плейсхолдер + ТекстПослеБлока;
		
		// Проверка прогресса: строка должна уменьшиться (код заменен на плейсхолдер)
		НоваяДлина = СтрДлина(Результат);
		Если НоваяДлина >= ПредыдущаяДлина Тогда
			Прервать;
		КонецЕсли;
		ПредыдущаяДлина = НоваяДлина;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область Таблицы

Функция ОбработатьТаблицы(Знач Текст)
	
	МассивСтрок = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = Новый Массив;
	
	КонтекстТаблицы = СоздатьКонтекстТаблицы();
	
	Для Индекс = 0 По МассивСтрок.ВГраница() Цикл
		
		Строка = МассивСтрок[Индекс];
		
		Если КонтекстТаблицы.ПропуститьСледующую Тогда
			КонтекстТаблицы.ПропуститьСледующую = Ложь;
			Продолжить;
		КонецЕсли;
		
		Если ЭтоСтрокаТаблицы(Строка) Тогда
			ОбработатьСтрокуВТаблице(Результат, КонтекстТаблицы, Строка, МассивСтрок, Индекс);
		Иначе
			ЗакрытьТаблицуЕслиОткрыта(Результат, КонтекстТаблицы);
			Результат.Добавить(Строка);
		КонецЕсли;
		
	КонецЦикла;
	
	ЗакрытьТаблицуЕслиОткрыта(Результат, КонтекстТаблицы);
	
	Возврат СтрСоединить(Результат, Символы.ПС);
	
КонецФункции

Функция СоздатьКонтекстТаблицы()
	
	Контекст = Новый Структура;
	Контекст.Вставить("ВТаблице", Ложь);
	Контекст.Вставить("ЕстьЗаголовок", Ложь);
	Контекст.Вставить("ПропуститьСледующую", Ложь);
	Возврат Контекст;
	
КонецФункции

Функция ЭтоСтрокаТаблицы(Знач Строка)
	
	Возврат СтрНачинаетсяС(СокрЛП(Строка), "|");
	
КонецФункции

Функция ЭтоРазделительЗаголовка(Знач Строка)
	
	СтрокаОбрезанная = СокрЛП(Строка);
	
	Если Не СтрНачинаетсяС(СтрокаОбрезанная, "|") Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Если СтрНайти(СтрокаОбрезанная, "---") = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Проверка = СтрокаОбрезанная;
	Проверка = СтрЗаменить(Проверка, "|", "");
	Проверка = СтрЗаменить(Проверка, "-", "");
	Проверка = СтрЗаменить(Проверка, ":", "");
	Проверка = СтрЗаменить(Проверка, " ", "");
	
	Возврат ПустаяСтрока(Проверка);
	
КонецФункции

Процедура ОбработатьСтрокуВТаблице(Результат, КонтекстТаблицы, Строка, МассивСтрок, Индекс)
	
	Если Не КонтекстТаблицы.ВТаблице Тогда
		ОткрытьНовуюТаблицу(Результат, КонтекстТаблицы);
	КонецЕсли;
	
	ЭтоЗаголовок = ПроверитьИДобавитьЗаголовок(Результат, КонтекстТаблицы, Строка, МассивСтрок, Индекс);
	
	Если Не ЭтоЗаголовок Тогда
		ДобавитьСтрокуТелаТаблицы(Результат, КонтекстТаблицы, Строка);
	КонецЕсли;
	
КонецПроцедуры

Процедура ОткрытьНовуюТаблицу(Результат, КонтекстТаблицы)
	
	Результат.Добавить("<table>");
	КонтекстТаблицы.ВТаблице = Истина;
	КонтекстТаблицы.ЕстьЗаголовок = Ложь;
	
КонецПроцедуры

Функция ПроверитьИДобавитьЗаголовок(Результат, КонтекстТаблицы, Строка, МассивСтрок, Индекс)
	
	Если Индекс >= МассивСтрок.ВГраница() Тогда
		Возврат Ложь;
	КонецЕсли;
	
	СледующаяСтрока = МассивСтрок[Индекс + 1];
	
	Если ЭтоРазделительЗаголовка(СледующаяСтрока) Тогда
		Результат.Добавить("<thead>");
		Результат.Добавить(ОбработатьСтрокуТаблицы(Строка, Истина));
		Результат.Добавить("</thead>");
		Результат.Добавить("<tbody>");
		КонтекстТаблицы.ЕстьЗаголовок = Истина;
		КонтекстТаблицы.ПропуститьСледующую = Истина;
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Процедура ДобавитьСтрокуТелаТаблицы(Результат, КонтекстТаблицы, Строка)
	
	Если Не КонтекстТаблицы.ЕстьЗаголовок Тогда
		Результат.Добавить("<tbody>");
		КонтекстТаблицы.ЕстьЗаголовок = Истина;
	КонецЕсли;
	
	Результат.Добавить(ОбработатьСтрокуТаблицы(Строка, Ложь));
	
КонецПроцедуры

Процедура ЗакрытьТаблицуЕслиОткрыта(Результат, КонтекстТаблицы)
	
	Если КонтекстТаблицы.ВТаблице Тогда
		Результат.Добавить("</tbody>");
		Результат.Добавить("</table>");
		КонтекстТаблицы.ВТаблице = Ложь;
		КонтекстТаблицы.ЕстьЗаголовок = Ложь;
		КонтекстТаблицы.ПропуститьСледующую = Ложь;
	КонецЕсли;
	
КонецПроцедуры

Функция ОбработатьСтрокуТаблицы(Знач Строка, Заголовок)
	
	МассивЯчеек = ПолучитьЯчейкиСтроки(Строка);
	Тег = ?(Заголовок, "th", "td");
	
	Результат = "<tr>";
	
	Для Каждого Ячейка Из МассивЯчеек Цикл
		ТекстЯчейки = ЭкранироватьHTML(СокрЛП(Ячейка));
		Результат = Результат + СтрШаблон("<%1>%2</%1>", Тег, ТекстЯчейки);
	КонецЦикла;
	
	Результат = Результат + "</tr>";
	Возврат Результат;
	
КонецФункции

Функция ПолучитьЯчейкиСтроки(Знач Строка)
	
	МассивЯчеек = СтрРазделить(Строка, "|", Ложь);
	
	// Удаляем пустые крайние элементы
	Если МассивЯчеек.Количество() > 0 И ПустаяСтрока(СокрЛП(МассивЯчеек[0])) Тогда
		МассивЯчеек.Удалить(0);
	КонецЕсли;
	
	Если МассивЯчеек.Количество() > 0 И ПустаяСтрока(СокрЛП(МассивЯчеек[МассивЯчеек.ВГраница()])) Тогда
		МассивЯчеек.Удалить(МассивЯчеек.ВГраница());
	КонецЕсли;
	
	Возврат МассивЯчеек;
	
КонецФункции

#КонецОбласти

#Область Списки

Функция ОбработатьСписки(Знач Текст)
	
	МассивСтрок = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = Новый Массив;
	
	КонтекстСписка = СоздатьКонтекстСписка();
	
	Для Каждого Строка Из МассивСтрок Цикл
		
		ТипЭлемента = ОпределитьТипЭлементаСписка(Строка);
		
		Если ТипЭлемента.ЭтоЭлементСписка Тогда
			ОбработатьЭлементСписка(Результат, КонтекстСписка, Строка, ТипЭлемента);
		Иначе
			ЗакрытьСписокЕслиОткрыт(Результат, КонтекстСписка);
			Результат.Добавить(Строка);
		КонецЕсли;
		
	КонецЦикла;
	
	ЗакрытьСписокЕслиОткрыт(Результат, КонтекстСписка);
	
	Возврат СтрСоединить(Результат, Символы.ПС);
	
КонецФункции

Функция СоздатьКонтекстСписка()
	
	Контекст = Новый Структура;
	Контекст.Вставить("ВСписке", Ложь);
	Контекст.Вставить("ТипСписка", "");
	Возврат Контекст;
	
КонецФункции

Функция ОпределитьТипЭлементаСписка(Знач Строка)
	
	СтрокаБезПробелов = СокрЛП(Строка);
	
	Результат = Новый Структура;
	Результат.Вставить("ЭтоЭлементСписка", Ложь);
	Результат.Вставить("ТипСписка", "");
	Результат.Вставить("ДлинаПрефикса", 0);
	
	// Проверка маркированного списка
	Если СтрНачинаетсяС(СтрокаБезПробелов, "- ")
		Или СтрНачинаетсяС(СтрокаБезПробелов, "* ")
		Или СтрНачинаетсяС(СтрокаБезПробелов, "+ ") Тогда
		
		Результат.ЭтоЭлементСписка = Истина;
		Результат.ТипСписка = "ul";
		Результат.ДлинаПрефикса = 2;
		Возврат Результат;
	КонецЕсли;
	
	// Проверка нумерованного списка
	ПроверкаНумерованного = ПроверитьНумерованныйСписок(СтрокаБезПробелов);
	Если ПроверкаНумерованного.ЭтоНумерованныйСписок Тогда
		Результат.ЭтоЭлементСписка = Истина;
		Результат.ТипСписка = "ol";
		Результат.ДлинаПрефикса = ПроверкаНумерованного.ДлинаПрефикса;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Функция ПроверитьНумерованныйСписок(Знач Строка)
	
	Результат = Новый Структура;
	Результат.Вставить("ЭтоНумерованныйСписок", Ложь);
	Результат.Вставить("ДлинаПрефикса", 0);
	
	Если СтрДлина(Строка) < 3 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Ищем цифры в начале
	ПозицияЦифры = 1;
	Пока ПозицияЦифры <= СтрДлина(Строка)
		И СтрНайти("0123456789", Сред(Строка, ПозицияЦифры, 1)) > 0 Цикл
		ПозицияЦифры = ПозицияЦифры + 1;
	КонецЦикла;
	
	Если ПозицияЦифры <= 1 Или ПозицияЦифры > СтрДлина(Строка) Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем разделитель (. или )) и пробел
	СимволРазделителя = Сред(Строка, ПозицияЦифры, 1);
	ЕстьПробел = (ПозицияЦифры + 1) <= СтрДлина(Строка) 
		И Сред(Строка, ПозицияЦифры + 1, 1) = " ";
	
	Если (СимволРазделителя = "." Или СимволРазделителя = ")") И ЕстьПробел Тогда
		Результат.ЭтоНумерованныйСписок = Истина;
		Результат.ДлинаПрефикса = ПозицияЦифры + 1;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ОбработатьЭлементСписка(Результат, КонтекстСписка, Строка, ТипЭлемента)
	
	ПереключитьТипСпискаЕслиНужно(Результат, КонтекстСписка, ТипЭлемента.ТипСписка);
	
	ТекстПункта = ИзвлечьТекстПунктаСписка(Строка, ТипЭлемента.ДлинаПрефикса);
	ТекстПункта = ЭкранироватьHTML(ТекстПункта);
	
	Результат.Добавить(СтрШаблон("<li>%1</li>", ТекстПункта));
	
КонецПроцедуры

Процедура ПереключитьТипСпискаЕслиНужно(Результат, КонтекстСписка, НовыйТипСписка)
	
	Если Не КонтекстСписка.ВСписке Тогда
		Результат.Добавить("<" + НовыйТипСписка + ">");
		КонтекстСписка.ВСписке = Истина;
		КонтекстСписка.ТипСписка = НовыйТипСписка;
		Возврат;
	КонецЕсли;
	
	Если КонтекстСписка.ТипСписка <> НовыйТипСписка Тогда
		Результат.Добавить("</" + КонтекстСписка.ТипСписка + ">");
		Результат.Добавить("<" + НовыйТипСписка + ">");
		КонтекстСписка.ТипСписка = НовыйТипСписка;
	КонецЕсли;
	
КонецПроцедуры

Функция ИзвлечьТекстПунктаСписка(Знач Строка, ДлинаПрефикса)
	
	Возврат СокрЛП(Сред(СокрЛП(Строка), ДлинаПрефикса + 1));
	
КонецФункции

Процедура ЗакрытьСписокЕслиОткрыт(Результат, КонтекстСписка)
	
	Если КонтекстСписка.ВСписке Тогда
		Результат.Добавить("</" + КонтекстСписка.ТипСписка + ">");
		КонтекстСписка.ВСписке = Ложь;
		КонтекстСписка.ТипСписка = "";
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область Ссылки

Функция ЗащититьСсылки(Знач Текст, СоответствиеСсылок)
	
	Результат = Текст;
	ПозицияПоиска = 1;
	
	Пока Истина Цикл
		
		Ссылка = НайтиСледующуюСсылку(Результат, ПозицияПоиска);
		
		Если Ссылка = Неопределено Тогда
			Прервать;
		КонецЕсли;
		
		Результат = ЗаменитьСсылкуНаПлейсхолдер(Результат, Ссылка, СоответствиеСсылок, ПозицияПоиска);
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция НайтиСледующуюСсылку(Знач Текст, ПозицияНачалаПоиска)
	
	ПозицииСсылки = НайтиПозицииСсылки(Текст, ПозицияНачалаПоиска);
	
	Если ПозицииСсылки = Неопределено Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ТекстСсылки = Сред(Текст, 
		ПозицииСсылки.НачалоТекста + 1, 
		ПозицииСсылки.КонецТекста - ПозицииСсылки.НачалоТекста - 1);
	
	ПолныйURL = СокрЛП(Сред(Текст, 
		ПозицииСсылки.НачалоURL + 2, 
		ПозицииСсылки.КонецURL - ПозицииСсылки.НачалоURL - 2));
	
	URL = ПолныйURL;
	Заголовок = "";
	
	ПозицияКавычки = СтрНайти(ПолныйURL, """");
	Если ПозицияКавычки > 0 Тогда
		URL = СокрЛП(Лев(ПолныйURL, ПозицияКавычки - 1));
		Заголовок = Сред(ПолныйURL, ПозицияКавычки + 1);
		Заголовок = СокрЛП(СтрЗаменить(Заголовок, """", ""));
	КонецЕсли;
	
	Ссылка = Новый Структура;
	Ссылка.Вставить("ТекстСсылки", ТекстСсылки);
	Ссылка.Вставить("URL", URL);
	Ссылка.Вставить("Заголовок", Заголовок);
	Ссылка.Вставить("ПозицияНачала", ПозицииСсылки.НачалоТекста);
	Ссылка.Вставить("ПозицияКонца", ПозицииСсылки.КонецURL);
	
	Возврат Ссылка;
	
КонецФункции

Функция НайтиПозицииСсылки(Знач Текст, ПозицияНачалаПоиска)
	
	ПозицияНачала = СтрНайти(Текст, "[", , ПозицияНачалаПоиска);
	Если ПозицияНачала = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПозицияКонцаТекста = СтрНайти(Текст, "]", , ПозицияНачала);
	Если ПозицияКонцаТекста = 0 Или ПозицияКонцаТекста >= СтрДлина(Текст) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если Сред(Текст, ПозицияКонцаТекста + 1, 1) <> "(" Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПозицияКонцаСсылки = СтрНайти(Текст, ")", , ПозицияКонцаТекста);
	Если ПозицияКонцаСсылки = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Позиции = Новый Структура;
	Позиции.Вставить("НачалоТекста", ПозицияНачала);
	Позиции.Вставить("КонецТекста", ПозицияКонцаТекста);
	Позиции.Вставить("НачалоURL", ПозицияКонцаТекста);
	Позиции.Вставить("КонецURL", ПозицияКонцаСсылки);
	
	Возврат Позиции;
	
КонецФункции

Функция ЗаменитьСсылкуНаПлейсхолдер(Знач Текст, Ссылка, СоответствиеСсылок, ПозицияПоиска)
	
	БезопасныйURL = ПроверитьИОчиститьURL(Ссылка.URL);
	БезопасныйТекст = ЭкранироватьHTML(Ссылка.ТекстСсылки); 
	
	Если ПустаяСтрока(Ссылка.Заголовок) Тогда
		HTMLСсылка = СтрШаблон("<a href=""%1"">%2</a>", БезопасныйURL, БезопасныйТекст);
	Иначе
		БезопасныйЗаголовок = ЭкранироватьHTML(Ссылка.Заголовок);
		HTMLСсылка = СтрШаблон("<a href=""%1"" title=""%2"">%3</a>", 
			БезопасныйURL, БезопасныйЗаголовок, БезопасныйТекст);
	КонецЕсли;
	
	Плейсхолдер = СформироватьПлейсхолдер("§§MDLINK:");
	СоответствиеСсылок.Вставить(Плейсхолдер, HTMLСсылка);
	
	ТекстДо = Лев(Текст, Ссылка.ПозицияНачала - 1);
	ТекстПосле = Сред(Текст, Ссылка.ПозицияКонца + 1);
	
	ПозицияПоиска = СтрДлина(ТекстДо) + СтрДлина(Плейсхолдер);
	
	Возврат ТекстДо + Плейсхолдер + ТекстПосле;
	
КонецФункции

Функция ПроверитьИОчиститьURL(Знач URL)
	
	URLНижний = НРег(СокрЛП(URL));
	
	ОпасныеПротоколы = Новый Массив;
	ОпасныеПротоколы.Добавить("javascript:");
	ОпасныеПротоколы.Добавить("data:");
	ОпасныеПротоколы.Добавить("vbscript:");
	ОпасныеПротоколы.Добавить("file:");
	
	Для Каждого Протокол Из ОпасныеПротоколы Цикл
		Если СтрНачинаетсяС(URLНижний, Протокол) Тогда
			Возврат "#";
		КонецЕсли;
	КонецЦикла;
	
	ПротоколБезопасен = СтрНачинаетсяС(URLНижний, "http://")
		Или СтрНачинаетсяС(URLНижний, "https://")
		Или СтрНачинаетсяС(URL, "/")
		Или СтрНачинаетсяС(URL, "./")
		Или СтрНачинаетсяС(URL, "../")
		Или СтрНачинаетсяС(URL, "#")
		Или СтрНачинаетсяС(URL, "mailto:");
	
	Если Не ПротоколБезопасен Тогда
		Возврат "#";
	КонецЕсли;
	
	Возврат ЭкранироватьHTML(URL);
	
КонецФункции

#КонецОбласти

#Область ГоризонтальныеЛинии

Функция ОбработатьГоризонтальныеЛинии(Знач Текст)

	МассивСтрок = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = Новый Массив;

	Для Каждого Строка Из МассивСтрок Цикл

		СтрокаБезПробелов = СокрЛП(Строка);

		Если СтрокаБезПробелов = "---"
			Или СтрокаБезПробелов = "***"
			Или СтрокаБезПробелов = "___" Тогда
			Результат.Добавить("<hr>");
		Иначе
			Результат.Добавить(Строка);
		КонецЕсли;

	КонецЦикла;

	Возврат СтрСоединить(Результат, Символы.ПС);

КонецФункции

#КонецОбласти

#Область Заголовки

Функция ОбработатьЗаголовки(Знач Текст)

	МассивСтрок = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = Новый Массив;

	Для Каждого Строка Из МассивСтрок Цикл

		СтрокаБезПробелов = СокрЛП(Строка);
		ОбработаннаяСтрока = Строка;

		МассивУровней = Новый Массив;
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "###### ", "h6"));
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "##### ", "h5"));
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "#### ", "h4"));
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "### ", "h3"));
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "## ", "h2"));
		МассивУровней.Добавить(Новый Структура("Префикс, Тег", "# ", "h1"));

		Для Каждого Уровень Из МассивУровней Цикл
			Если СтрНачинаетсяС(СтрокаБезПробелов, Уровень.Префикс) Тогда
				ТекстЗаголовка = Сред(СтрокаБезПробелов, СтрДлина(Уровень.Префикс) + 1);
				ТекстЗаголовка = ЭкранироватьHTML(ТекстЗаголовка);
				ОбработаннаяСтрока = СтрШаблон("<%1>%2</%1>", Уровень.Тег, ТекстЗаголовка);
				Прервать;
			КонецЕсли;
		КонецЦикла;

		Результат.Добавить(ОбработаннаяСтрока);

	КонецЦикла;

	Возврат СтрСоединить(Результат, Символы.ПС);

КонецФункции

#КонецОбласти

#Область Цитаты

Функция ОбработатьЦитаты(Знач Текст)
	
	МассивСтрок = СтрРазделить(Текст, Символы.ПС, Ложь);
	Результат = Новый Массив;
	ТекущийУровень = 0;
	
	Для Каждого Строка Из МассивСтрок Цикл
		
		УровеньЦитаты = ОпределитьУровеньЦитаты(Строка);
		
		Если УровеньЦитаты.Уровень > 0 Тогда
			ТекущийУровень = ОбработатьСтрокуЦитаты(Результат, ТекущийУровень, УровеньЦитаты);
		Иначе
			ТекущийУровень = ЗакрытьВсеУровниЦитат(Результат, ТекущийУровень);
			Результат.Добавить(Строка);
		КонецЕсли;
		
	КонецЦикла;
	
	ТекущийУровень = ЗакрытьВсеУровниЦитат(Результат, ТекущийУровень);
	
	Возврат СтрСоединить(Результат, Символы.ПС);
	
КонецФункции

Функция ОпределитьУровеньЦитаты(Знач Строка)
	
	СтрокаСокрЛП = СокрЛП(Строка);
	
	Уровень = 0;
	Позиция = 1;
	
	Пока Позиция <= СтрДлина(СтрокаСокрЛП)
		И Сред(СтрокаСокрЛП, Позиция, 1) = ">" Цикл
		Уровень = Уровень + 1;
		Позиция = Позиция + 1;
	КонецЦикла;
	
	// Пропускаем пробел после последнего >
	Если Позиция <= СтрДлина(СтрокаСокрЛП)
		И Сред(СтрокаСокрЛП, Позиция, 1) = " " Тогда
		Позиция = Позиция + 1;
	КонецЕсли;
	
	ТекстЦитаты = СокрЛП(Сред(СтрокаСокрЛП, Позиция));
	
	Результат = Новый Структура;
	Результат.Вставить("Уровень", Уровень);
	Результат.Вставить("Текст", ТекстЦитаты);
	
	Возврат Результат;
	
КонецФункции

Функция ОбработатьСтрокуЦитаты(Результат, ТекущийУровень, УровеньЦитаты)
	
	НовыйУровень = ПерейтиНаУровеньЦитаты(Результат, ТекущийУровень, УровеньЦитаты.Уровень);
	
	ТекстЦитаты = ЭкранироватьHTML(УровеньЦитаты.Текст);
	Результат.Добавить(ТекстЦитаты);
	
	Возврат НовыйУровень;
	
КонецФункции

Функция ПерейтиНаУровеньЦитаты(Результат, ТекущийУровень, НовыйУровень)
	
	Пока ТекущийУровень < НовыйУровень Цикл
		Результат.Добавить("<blockquote>");
		ТекущийУровень = ТекущийУровень + 1;
	КонецЦикла;
	
	Пока ТекущийУровень > НовыйУровень Цикл
		Результат.Добавить("</blockquote>");
		ТекущийУровень = ТекущийУровень - 1;
	КонецЦикла;
	
	Возврат ТекущийУровень;
	
КонецФункции

Функция ЗакрытьВсеУровниЦитат(Результат, ТекущийУровень)
	
	Пока ТекущийУровень > 0 Цикл
		Результат.Добавить("</blockquote>");
		ТекущийУровень = ТекущийУровень - 1;
	КонецЦикла;
	
	Возврат ТекущийУровень;
	
КонецФункции

#КонецОбласти

#Область ИнлайнКод

Функция ЗащититьИнлайнКод(Знач Текст, СоответствиеИнлайнКода)
	
	Результат = Текст;
	ПозицияПоиска = 1;
	
	Пока Истина Цикл
		
		ИнлайнКод = НайтиСледующийИнлайнКод(Результат, ПозицияПоиска);
		
		Если ИнлайнКод = Неопределено Тогда
			Прервать;
		КонецЕсли;
		
		Результат = ЗаменитьИнлайнКодНаПлейсхолдер(Результат, ИнлайнКод, СоответствиеИнлайнКода, ПозицияПоиска);
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция НайтиСледующийИнлайнКод(Знач Текст, ПозицияНачалаПоиска)
	
	ПозицияПервойКавычки = СтрНайти(Текст, "`", , ПозицияНачалаПоиска);
	Если ПозицияПервойКавычки = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	ПозицияВторойКавычки = СтрНайти(Текст, "`", , ПозицияПервойКавычки + 1);
	Если ПозицияВторойКавычки = 0 Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Код = Сред(Текст, ПозицияПервойКавычки + 1, ПозицияВторойКавычки - ПозицияПервойКавычки - 1);
	
	ИнлайнКод = Новый Структура;
	ИнлайнКод.Вставить("ПозицияНачала", ПозицияПервойКавычки);
	ИнлайнКод.Вставить("ПозицияКонца", ПозицияВторойКавычки);
	ИнлайнКод.Вставить("Код", Код);
	
	Возврат ИнлайнКод;
	
КонецФункции

Функция ЗаменитьИнлайнКодНаПлейсхолдер(Знач Текст, ИнлайнКод, СоответствиеИнлайнКода, ПозицияПоиска)
	
	КодЭкранированный = ЭкранироватьHTML(ИнлайнКод.Код);
	HTMLКод = "<code>" + КодЭкранированный + "</code>";
	
	Плейсхолдер = СформироватьПлейсхолдер("§§MDINLINECODE:");
	СоответствиеИнлайнКода.Вставить(Плейсхолдер, HTMLКод);
	
	ТекстДо = Лев(Текст, ИнлайнКод.ПозицияНачала - 1);
	ТекстПосле = Сред(Текст, ИнлайнКод.ПозицияКонца + 1);
	
	ПозицияПоиска = СтрДлина(ТекстДо) + СтрДлина(Плейсхолдер);
	
	Возврат ТекстДо + Плейсхолдер + ТекстПосле;
	
КонецФункции

#КонецОбласти

#Область ПарныеТеги

Функция ОбработатьПарныеТеги(Знач Текст, Маркер, ОткрывающийТег, ЗакрывающийТег)
	
	Результат = Текст;
	ДлинаМаркера = СтрДлина(Маркер); 
	
	КоличествоМаркеров = 0;
	ПозицияПоиска = 1;
	
	Пока Истина Цикл
		Позиция = СтрНайти(Результат, Маркер, , ПозицияПоиска);
		Если Позиция = 0 Тогда
			Прервать;
		КонецЕсли;
		КоличествоМаркеров = КоличествоМаркеров + 1;
		ПозицияПоиска = Позиция + ДлинаМаркера;
	КонецЦикла;
	
	КоличествоПар = Цел(КоличествоМаркеров / 2);
	
	Открыт = Ложь;
	Для Счетчик = 1 По КоличествоПар * 2 Цикл
		
		Позиция = СтрНайти(Результат, Маркер);
		Если Позиция = 0 Тогда
			Прервать;
		КонецЕсли;
		
		Если Не Открыт Тогда
			Результат = Лев(Результат, Позиция - 1) 
				+ ОткрывающийТег 
				+ Сред(Результат, Позиция + ДлинаМаркера);
			Открыт = Истина;
		Иначе
			Результат = Лев(Результат, Позиция - 1) 
				+ ЗакрывающийТег 
				+ Сред(Результат, Позиция + ДлинаМаркера);
			Открыт = Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
#КонецОбласти
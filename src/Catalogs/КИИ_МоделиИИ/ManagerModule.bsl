#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда
#Область ПрограммныйИнтерфейс

// Заполняет справочник предустановленными моделями ИИ из макета
//
Процедура ЗаполнитьПредустановленныеМодели() Экспорт
	
	МакетJSON = ПолучитьМакет("ПредустановленныеМодели");
	ТекстJSON = МакетJSON.ПолучитьТекст();
	
	Попытка
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ТекстJSON);
		МассивМоделей = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
	Исключение
		
		ТекстОшибки = СтрШаблон(
			НСтр("ru = 'Ошибка парсинга JSON макета: %1'"),
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'КИИ.Заполнение моделей'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			ТекстОшибки);
		
		ВызватьИсключение ТекстОшибки;
		
	КонецПопытки;
	
	Если ТипЗнч(МассивМоделей) <> Тип("Массив") Тогда
		ВызватьИсключение НСтр("ru = 'Макет должен содержать массив моделей'");
	КонецЕсли;
	
	КоличествоСоздано = 0;
	КоличествоОбновлено = 0;
	
	НачатьТранзакцию();
	
	Попытка
		
		Для Каждого ДанныеМодели Из МассивМоделей Цикл
			
			Если СоздатьИлиОбновитьМодель(ДанныеМодели) Тогда
				КоличествоСоздано = КоличествоСоздано + 1;
			Иначе
				КоличествоОбновлено = КоличествоОбновлено + 1;
			КонецЕсли;
			
		КонецЦикла;
		
		ЗафиксироватьТранзакцию();
		
	Исключение
		
		ОтменитьТранзакцию();
		
		ТекстОшибки = СтрШаблон(
			НСтр("ru = 'Ошибка заполнения моделей: %1'"),
			ОбработкаОшибок.ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
		
		ЗаписьЖурналаРегистрации(
			НСтр("ru = 'КИИ.Заполнение моделей'", ОбщегоНазначения.КодОсновногоЯзыка()),
			УровеньЖурналаРегистрации.Ошибка,
			,
			,
			ТекстОшибки);
		
		ВызватьИсключение ТекстОшибки;
		
	КонецПопытки;
	
	СообщениеЛога = СтрШаблон(
		НСтр("ru = 'Заполнение моделей завершено. Создано: %1, обновлено: %2'"),
		КоличествоСоздано,
		КоличествоОбновлено);
	
	ЗаписьЖурналаРегистрации(
		НСтр("ru = 'КИИ.Заполнение моделей'", ОбщегоНазначения.КодОсновногоЯзыка()),
		УровеньЖурналаРегистрации.Информация,
		,
		,
		СообщениеЛога);
	
КонецПроцедуры

// Проверяет наличие моделей в справочнике
//
// Возвращаемое значение:
//  Булево - Истина, если в справочнике есть хотя бы одна модель
//
Функция МоделиЗаполнены() Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ ПЕРВЫЕ 1
		|	КИИ_МоделиИИ.Ссылка КАК Ссылка
		|ИЗ
		|	Справочник.КИИ_МоделиИИ КАК КИИ_МоделиИИ
		|ГДЕ
		|	НЕ КИИ_МоделиИИ.ПометкаУдаления";
	
	Результат = Запрос.Выполнить();
	
	Возврат Не Результат.Пустой();
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Функция СоздатьИлиОбновитьМодель(ДанныеМодели)
	
	Если Не ЗначениеЗаполнено(ДанныеМодели.Наименование) Тогда
		ВызватьИсключение НСтр("ru = 'Отсутствует обязательное поле ""Наименование""'");
	КонецЕсли;
	
	СсылкаНаМодель = Справочники.КИИ_МоделиИИ.НайтиПоНаименованию(ДанныеМодели.Наименование);
	
	Если ЗначениеЗаполнено(СсылкаНаМодель) Тогда
		МодельОбъект = СсылкаНаМодель.ПолучитьОбъект();
		Создана = Ложь;
	Иначе
		МодельОбъект = Справочники.КИИ_МоделиИИ.СоздатьЭлемент();
		МодельОбъект.Заполнить(Неопределено);
		МодельОбъект.Наименование = ДанныеМодели.Наименование;
		Создана = Истина;
	КонецЕсли;
	
	ЗаполнитьРеквизитыМодели(МодельОбъект, ДанныеМодели);
	ЗаполнитьЗаголовкиМодели(МодельОбъект, ДанныеМодели);
	
	Блокировка = Новый БлокировкаДанных;
	ЭлементБлокировки = Блокировка.Добавить("Справочник.КИИ_МоделиИИ");
	ЭлементБлокировки.УстановитьЗначение("Ссылка", МодельОбъект.Ссылка);
	Блокировка.Заблокировать();
	МодельОбъект.Записать();
	
	Возврат Создана;
	
КонецФункции

Процедура ЗаполнитьРеквизитыМодели(МодельОбъект, ДанныеМодели)
	
	Если Не ЗначениеЗаполнено(ДанныеМодели.НаименованиеПолное) Тогда
		ВызватьИсключение НСтр("ru = 'Отсутствует обязательное поле ""НаименованиеПолное""'");
	КонецЕсли;
	МодельОбъект.НаименованиеПолное = ДанныеМодели.НаименованиеПолное;
	
	Если Не ЗначениеЗаполнено(ДанныеМодели.Адрес) Тогда
		ВызватьИсключение НСтр("ru = 'Отсутствует обязательное поле ""Адрес""'");
	КонецЕсли;
	МодельОбъект.Адрес = ДанныеМодели.Адрес;
	
	Если Не ЗначениеЗаполнено(ДанныеМодели.АдресЗапроса) Тогда
		ВызватьИсключение НСтр("ru = 'Отсутствует обязательное поле ""АдресЗапроса""'");
	КонецЕсли;
	МодельОбъект.АдресЗапроса = ДанныеМодели.АдресЗапроса;
	
	Если ДанныеМодели.Свойство("ИспользоватьЗащищенноеСоединение") Тогда
		МодельОбъект.ИспользоватьЗащищенноеСоединение = ДанныеМодели.ИспользоватьЗащищенноеСоединение;
	Иначе
		МодельОбъект.ИспользоватьЗащищенноеСоединение = Истина;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("НаименованиеПровайдера") Тогда
		МодельОбъект.НаименованиеПровайдера = ДанныеМодели.НаименованиеПровайдера;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("ИмяПоляТекста") Тогда
		МодельОбъект.ИмяПоляТекста = ДанныеМодели.ИмяПоляТекста;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("Описание") Тогда
		МодельОбъект.Описание = ДанныеМодели.Описание;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("Температура") Тогда
		МодельОбъект.Температура = ДанныеМодели.Температура;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("МаксимумТокенов") Тогда
		МодельОбъект.МаксимумТокенов = ДанныеМодели.МаксимумТокенов;
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("ТипФорматаAPI") И ЗначениеЗаполнено(ДанныеМодели.ТипФорматаAPI) Тогда
		МодельОбъект.ТипФорматаAPI = Перечисления.КИИ_ТипыФорматовAPI[ДанныеМодели.ТипФорматаAPI];
	КонецЕсли;
	
	Если ДанныеМодели.Свойство("ТипАвторизации") И ЗначениеЗаполнено(ДанныеМодели.ТипАвторизации) Тогда
		МодельОбъект.ТипАвторизации = Перечисления.КИИ_ТипыАвторизации[ДанныеМодели.ТипАвторизации];
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьЗаголовкиМодели(МодельОбъект, ДанныеМодели)
	
	Если Не ДанныеМодели.Свойство("Заголовки") Тогда
		Возврат;
	КонецЕсли;
	
	Если ТипЗнч(ДанныеМодели.Заголовки) <> Тип("Массив") Тогда
		Возврат;
	КонецЕсли;
	
	МодельОбъект.Заголовки.Очистить();
	
	Для Каждого ДанныеЗаголовка Из ДанныеМодели.Заголовки Цикл
		
		Если Не ЗначениеЗаполнено(ДанныеЗаголовка.Ключ) Или Не ЗначениеЗаполнено(ДанныеЗаголовка.Значение) Тогда
			Продолжить;
		КонецЕсли;
		
		НоваяСтрока = МодельОбъект.Заголовки.Добавить();
		НоваяСтрока.Ключ = ДанныеЗаголовка.Ключ;
		НоваяСтрока.Значение = ДанныеЗаголовка.Значение;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли